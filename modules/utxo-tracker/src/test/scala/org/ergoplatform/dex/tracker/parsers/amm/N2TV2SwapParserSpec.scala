package org.ergoplatform.dex.tracker.parsers.amm

import cats.effect.{Clock, SyncIO}
import org.ergoplatform.ErgoAddressEncoder
import org.ergoplatform.dex.CatsPlatform
import org.ergoplatform.dex.domain.AssetAmount
import org.ergoplatform.dex.domain.amm.CFMMOrder.SwapMultiAddress
import org.ergoplatform.dex.domain.amm.{CFMMOrder, PoolId, SwapParams}
import org.ergoplatform.dex.protocol.ErgoTreeSerializer
import org.ergoplatform.dex.protocol.amm.{AMMType, N2TCFMMTemplates, ParserVersion}
import org.ergoplatform.dex.tracker.parsers.amm.v2.N2TOrdersV2Parser
import org.ergoplatform.ergo._
import org.ergoplatform.ergo.domain.Output
import org.scalatest.matchers.should
import org.scalatest.propspec.AnyPropSpec
import org.scalatestplus.scalacheck.ScalaCheckPropertyChecks

class N2TV2SwapParserSpec
  extends AnyPropSpec
  with should.Matchers
  with ScalaCheckPropertyChecks
  with CatsPlatform {

  implicit val clock: Clock[SyncIO] = Clock.create

  property("Ergo tree from swaps should be deserializable ") {
    val swapBuy = parser.swap(boxSampleSwapBuy).unsafeRunSync().get match {
      case swap: SwapMultiAddress => swap
    }

    val `tryBuy` = ErgoTreeSerializer.default.deserialize(swapBuy.params.redeemer)

    val swapSell = parser.swap(boxSampleSwapSell).unsafeRunSync().get match {
      case swap: SwapMultiAddress => swap
    }

    val `trySell` = ErgoTreeSerializer.default.deserialize(swapSell.params.redeemer)

    `tryBuy` shouldBe `trySell`
  }

  property("N2T parser should parse swap buy multi address order correct") {
    val tree = ErgoTreeSerializer.default.deserialize(sErgoTreeSwapBuy)

    val template = ErgoTreeTemplate.fromBytes(tree.template)

    N2TCFMMTemplates.swapBuyMultiAddressV2 shouldEqual template

    val order = parser.swap(boxSampleSwapBuy).unsafeRunSync().get

    val expectedSwapOrder = CFMMOrder.SwapMultiAddress(
      PoolId.fromStringUnsafe("4ad32364b11b0fc1cc66e6528b5ad8cbc31f2f63793357316bf15c8ef283ad4c"),
      10000000L,
      order.timestamp,
      SwapParams(
        AssetAmount(
          TokenId.fromStringUnsafe("30974274078845f263b4f21787e33cc99e9ec19a17ad85a5bc6da2cca91c5a2e"),
          10000000L
        ),
        AssetAmount(
          TokenId.fromStringUnsafe("0000000000000000000000000000000000000000000000000000000000000000"),
          3L
        ),
        10000000L,
        5L,
        redeemerSwapBuy
      ),
      boxSampleSwapBuy
    )

    order shouldEqual expectedSwapOrder
  }

  property("N2T parser should parse swap sell multi address order correct") {
    val tree     = ErgoTreeSerializer.default.deserialize(sErgoTreeSwapSell)
    val template = ErgoTreeTemplate.fromBytes(tree.template)

    N2TCFMMTemplates.swapSellMultiAddressV2 shouldEqual template

    val order = parser.swap(boxSampleSwapSell).unsafeRunSync().get

    val expectedSwapOrder = CFMMOrder.SwapMultiAddress(
      PoolId.fromStringUnsafe("4ad32364b11b0fc1cc66e6528b5ad8cbc31f2f63793357316bf15c8ef283ad4c"),
      10000000L,
      order.timestamp,
      SwapParams(
        AssetAmount(
          TokenId.fromStringUnsafe("0000000000000000000000000000000000000000000000000000000000000000"),
          18L
        ),
        AssetAmount(
          TokenId.fromStringUnsafe("30974274078845f263b4f21787e33cc99e9ec19a17ad85a5bc6da2cca91c5a2e"),
          3L
        ),
        101L,
        105L,
        redeemerSwapSell
      ),
      boxSampleSwapSell
    )

    order shouldEqual expectedSwapOrder
  }

  implicit val e: ErgoAddressEncoder = new ErgoAddressEncoder(ErgoAddressEncoder.MainnetNetworkPrefix)

  def parser: CFMMOrdersParser[AMMType.N2T_CFMM, ParserVersion.V2, SyncIO] =
    N2TOrdersV2Parser.make[SyncIO]

  def sErgoTreeSwapBuy =
    SErgoTree.unsafeFromString(
      "101604000100040404060402050a05f5d9c409040004000e204ad32364b11b0fc1cc66e6528b5ad8cbc31f2f63793357316bf15c8ef2" +
      "83ad4c0eb40319b1031208cd033d6ab05cfb8a65938e116cb863cad577e560bb8e110113bf395fbe98649dbb590400040404060402" +
      "04000404040005feffffffffffffffff01040204000e209916d75132593c8b07fe18bd8d583bda1652eed7565cf41a4738ddd90fc9" +
      "92ec0580b6dc050e691005040004000e36100204a00b08cd0279be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b" +
      "16f81798ea02d192a39a8cc7a701730073011001020402d19683030193a38cc7b2a57300000193c2b2a57301007473027303830108" +
      "cdeeac93b1a5730405000500058092f4010100d802d6017300d602b2a4730100eb027201d195ed93b1a4730293b1db630872027303" +
      "d806d603db63087202d604b2a5730400d605b2db63087204730500d606b27203730600d6077e8cb2db6308a77307000206d6087e99" +
      "73088cb272037309000206ededededed938cb27203730a0001730b93c27204d07201938c7205018c720601927e9a99c17204c1a773" +
      "0c069d9c72077ec17202067208927e8c720502069d9c72077e8c72060206720890b0ada5d90109639593c27209730dc17209730e73" +
      "0fd90109599a8c7209018c72090273107311050604c80f060101040404d00f04c80f0e691005040004000e36100204a00b08cd0279" +
      "be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798ea02d192a39a8cc7a701730073011001020402d19683" +
      "030193a38cc7b2a57300000193c2b2a57301007473027303830108cdeeac93b1a57304050005000580dac4090100d801d601b2a473" +
      "0000d1ec730195ed93b1a4730293b1db630872017303d804d602db63087201d603b2a5730400d6049d9c7e99c17203c1a7067e7305" +
      "067e730606d6058cb2db6308a773070002edededed938cb2720273080001730993c27203730a9272047e730b06909c9c7ec1720106" +
      "7e7205067e730c069c9a7204730d9a9c7e8cb27202730e0002067e730f067e9c72057e7310050690b0ada5d90106639593c2720673" +
      "11c1720673127313d90106599a8c7206018c72060273147315"
    )

  def boxSampleSwapBuy =
    io.circe.parser
      .decode[Output](
        s"""
           |{
           |    "boxId": "1df6f07bf4334812ee8376c035e62795567fd9904195a972c25425d15321aab7",
           |    "transactionId": "e611dec1c41f5efe281092bd72f63cfe0c5c0cd7639fe78d832807dca923c559",
           |    "blockId": "0b36bf5e78c677446726af56a65a6bf3533dee2ff6b795de407cb4f71312e0e8",
           |    "value": 51650000,
           |    "index": 0,
           |    "globalIndex": 23349051,
           |    "creationHeight": 508928,
           |    "settlementHeight": 868982,
           |    "ergoTree": "101604000100040404060402050a05f5d9c409040004000e204ad32364b11b0fc1cc66e6528b5ad8cbc31f2f63793357316bf15c8ef283ad4c0eb40319b1031208cd033d6ab05cfb8a65938e116cb863cad577e560bb8e110113bf395fbe98649dbb59040004040406040204000404040005feffffffffffffffff01040204000e209916d75132593c8b07fe18bd8d583bda1652eed7565cf41a4738ddd90fc992ec0580b6dc050e691005040004000e36100204a00b08cd0279be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798ea02d192a39a8cc7a701730073011001020402d19683030193a38cc7b2a57300000193c2b2a57301007473027303830108cdeeac93b1a5730405000500058092f4010100d802d6017300d602b2a4730100eb027201d195ed93b1a4730293b1db630872027303d806d603db63087202d604b2a5730400d605b2db63087204730500d606b27203730600d6077e8cb2db6308a77307000206d6087e9973088cb272037309000206ededededed938cb27203730a0001730b93c27204d07201938c7205018c720601927e9a99c17204c1a7730c069d9c72077ec17202067208927e8c720502069d9c72077e8c72060206720890b0ada5d90109639593c27209730dc17209730e730fd90109599a8c7209018c72090273107311050604c80f060101040404d00f04c80f0e691005040004000e36100204a00b08cd0279be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798ea02d192a39a8cc7a701730073011001020402d19683030193a38cc7b2a57300000193c2b2a57301007473027303830108cdeeac93b1a57304050005000580dac4090100d801d601b2a4730000d1ec730195ed93b1a4730293b1db630872017303d804d602db63087201d603b2a5730400d6049d9c7e99c17203c1a7067e7305067e730606d6058cb2db6308a773070002edededed938cb2720273080001730993c27203730a9272047e730b06909c9c7ec17201067e7205067e730c069c9a7204730d9a9c7e8cb27202730e0002067e730f067e9c72057e7310050690b0ada5d90106639593c272067311c1720673127313d90106599a8c7206018c72060273147315",
           |    "address": "o9iYvHqCdt9nYCKYgs2md7cQUgfVHYtYz5rt5CdWcJ322bc4LEGCwfUbb3yEANBM9yGK7qriwCkuFEeseLJABcncPaXkeZXKfQ9PfjnK8nCFKWgqrVd3ob8Cc1bhKK2eUzC5Rzpd9xxABcDuuBrcxNNCocT9qBwHh1FtuDr3iFQowbPuAG5xyNowfzrkTCm2nJ3HvhdYgDQTsJnkfSrAoUuAvvYKH4AqfnURYPpXxWK2ENzxoVtQB8GVCU6K4xGLftzGBMWisuucuMdhFuHA6rMgzjyj1CdNwYrN2sLjFoNB78QptXBZTQowncLGQd3MieYd5LN1VdFDvfAHfShTeufTntNAQJZsczaExKVcnraVqqbqgegar7yxqYajFzaBgumcGKHBqArVscDodUDRxJWkBnQP6zqX9Z9zztX4THysfiKBMdWTKCRTwAAVAmupZnaUVfELmcQnMtfk52fDWht66sHodRsbuaRVLiGW6g8dbbwagxqBYy9L98uKMqHaA1ZyYpFuYKza7HvUGZrFWQjVmsacPgk34PjJhWhDYAJjE4pGyZ47dFmvGFrS781yXiryaWceDXKQoSSpPkXuyBFN1Zc7REtjHD55SZVKL7H1jpP8Ex7sFYhjbc879J9BQz1EZiaV9gNHbxjyf3mhUaxZdBTs2syEW3V2PUptviUp6SbxWkDnusk9tksTUbYbWHEHtiJc9Bqyu1ijFvh4ooicFuHdyQJi3njpqSe6rBznZiGF2ePyAdB52NMRAZ7MdoTuVvWrTDGvF4DATnjn4vV7v1ngyYHyNarXo48NytN9pET1sbdnfhvtfc2hKZzWLPdGyyvSAYykcDXG6C3CR3fEL9wYfHXbQNKgtTGiehs1ByXhsQHJg6PJsTrV6hAHquiruuC9y86PcMsKydrveRTbN5WZK9Vi22tEiN5GeF2Y4j3zx8ZRAdJ6gnqXUraEX8Ds1Zdp4QSptVAbhVmx6TmD9rApSwk26f5s4TJj2jZvDRKZd4p1u36cq5fVAsqZrhwVv8bRkuu8QKEqt2ADyDLotmerovhE544nJ8U6nMMh3WxEFvCbh9ANgYVyeExLWGPZ9i9MSmpW2fmniqpaXHJevrwFd3B94A2PEQF",
           |    "assets": [
           |        {
           |            "tokenId": "30974274078845f263b4f21787e33cc99e9ec19a17ad85a5bc6da2cca91c5a2e",
           |            "index": 0,
           |            "amount": 10000000,
           |            "name": "WT_ADA",
           |            "decimals": 8,
           |            "type": "EIP-004"
           |        }
           |    ],
           |    "additionalRegisters": {},
           |    "spentTransactionId": "8dde27e825c347334d30d6be7078df736c450e015cc243156878056f709d62e6",
           |    "mainChain": true
           |}
           |""".stripMargin
      )
      .toOption
      .get

  def redeemerSwapBuy = SErgoTree.unsafeFromString(
    "19b1031208cd033d6ab05cfb8a65938e116cb863cad577e560bb8e110113bf395fbe98649dbb59040004040406040204000404040005" +
    "feffffffffffffffff01040204000e209916d75132593c8b07fe18bd8d583bda1652eed7565cf41a4738ddd90fc992ec0580b6dc05" +
    "0e691005040004000e36100204a00b08cd0279be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798ea02d1" +
    "92a39a8cc7a701730073011001020402d19683030193a38cc7b2a57300000193c2b2a57301007473027303830108cdeeac93b1a573" +
    "0405000500058092f4010100d802d6017300d602b2a4730100eb027201d195ed93b1a4730293b1db630872027303d806d603db6308" +
    "7202d604b2a5730400d605b2db63087204730500d606b27203730600d6077e8cb2db6308a77307000206d6087e9973088cb2720373" +
    "09000206ededededed938cb27203730a0001730b93c27204d07201938c7205018c720601927e9a99c17204c1a7730c069d9c72077e" +
    "c17202067208927e8c720502069d9c72077e8c72060206720890b0ada5d90109639593c27209730dc17209730e730fd90109599a8c" +
    "7209018c72090273107311"
  )

  def sErgoTreeSwapSell = SErgoTree.unsafeFromString(
    "101904000601120100040404060402040004000e204ad32364b11b0fc1cc66e6528b5ad8cbc31f2f63793357316bf15c8ef283a" +
    "d4c0eb40319b1031208cd033d6ab05cfb8a65938e116cb863cad577e560bb8e110113bf395fbe98649dbb5904000404040604" +
    "0204000404040005feffffffffffffffff01040204000e209916d75132593c8b07fe18bd8d583bda1652eed7565cf41a4738d" +
    "dd90fc992ec0580b6dc050e691005040004000e36100204a00b08cd0279be667ef9dcbbac55a06295ce870b07029bfcdb2dce" +
    "28d959f2815b16f81798ea02d192a39a8cc7a701730073011001020402d19683030193a38cc7b2a57300000193c2b2a573010" +
    "07473027303830108cdeeac93b1a5730405000500058092f4010100d802d6017300d602b2a4730100eb027201d195ed93b1a4" +
    "730293b1db630872027303d806d603db63087202d604b2a5730400d605b2db63087204730500d606b27203730600d6077e8cb" +
    "2db6308a77307000206d6087e9973088cb272037309000206ededededed938cb27203730a0001730b93c27204d07201938c72" +
    "05018c720601927e9a99c17204c1a7730c069d9c72077ec17202067208927e8c720502069d9c72077e8c72060206720890b0a" +
    "da5d90109639593c27209730dc17209730e730fd90109599a8c7209018c720902731073110e2030974274078845f263b4f217" +
    "87e33cc99e9ec19a17ad85a5bc6da2cca91c5a2e050605ca0105d201040404c80f06010104d00f052404c80f0e69100504000" +
    "4000e36100204a00b08cd0279be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798ea02d192a39a8c" +
    "c7a701730073011001020402d19683030193a38cc7b2a57300000193c2b2a57301007473027303830108cdeeac93b1a573040" +
    "50005000580dac4090100d802d601b2a4730000d6027301d1ec730295ed93b1a4730393b1db630872017304d804d603db6308" +
    "7201d604b2a5730500d605b2db63087204730600d6067e8c72050206edededededed938cb2720373070001730893c27204730" +
    "9938c720501730a9272067e730b06927ec172040699997ec1a7069d9c72067e730c067e730d067202909c9c7e8cb27203730e" +
    "00020672027e730f069c9a720673109a9c7ec17201067e7311067e9c73127e7313050690b0ada5d90107639593c272077314c" +
    "1720773157316d90107599a8c7207018c72070273177318"
  )

  def redeemerSwapSell = SErgoTree.unsafeFromString(
    "19b1031208cd033d6ab05cfb8a65938e116cb863cad577e560bb8e110113bf395fbe98649dbb590400040404060402040004040" +
    "40005feffffffffffffffff01040204000e209916d75132593c8b07fe18bd8d583bda1652eed7565cf41a4738ddd90fc992ec" +
    "0580b6dc050e691005040004000e36100204a00b08cd0279be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815" +
    "b16f81798ea02d192a39a8cc7a701730073011001020402d19683030193a38cc7b2a57300000193c2b2a57301007473027303" +
    "830108cdeeac93b1a5730405000500058092f4010100d802d6017300d602b2a4730100eb027201d195ed93b1a4730293b1db6" +
    "30872027303d806d603db63087202d604b2a5730400d605b2db63087204730500d606b27203730600d6077e8cb2db6308a773" +
    "07000206d6087e9973088cb272037309000206ededededed938cb27203730a0001730b93c27204d07201938c7205018c72060" +
    "1927e9a99c17204c1a7730c069d9c72077ec17202067208927e8c720502069d9c72077e8c72060206720890b0ada5d9010963" +
    "9593c27209730dc17209730e730fd90109599a8c7209018c72090273107311"
  )

  def boxSampleSwapSell =
    io.circe.parser
      .decode[Output](
        s"""
           |{
           |    "boxId": "f49e548021b775cf7e61672803e8a14fa4e5f34b6c3f85228b5a6e2971f76936",
           |    "transactionId": "af9b3f348c0ca58545fe7bbc1d8c3fb5708a01f6f798177579adef6ef5c85141",
           |    "blockId": "de59a7402f66ac37c5bb2744ac540dd3ad0614f779e1cb9d9c03ec8576fa9bf1",
           |    "value": 42904851,
           |    "index": 0,
           |    "globalIndex": 23347719,
           |    "creationHeight": 506880,
           |    "settlementHeight": 868957,
           |    "ergoTree": "101904000601120100040404060402040004000e204ad32364b11b0fc1cc66e6528b5ad8cbc31f2f63793357316bf15c8ef283ad4c0eb40319b1031208cd033d6ab05cfb8a65938e116cb863cad577e560bb8e110113bf395fbe98649dbb59040004040406040204000404040005feffffffffffffffff01040204000e209916d75132593c8b07fe18bd8d583bda1652eed7565cf41a4738ddd90fc992ec0580b6dc050e691005040004000e36100204a00b08cd0279be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798ea02d192a39a8cc7a701730073011001020402d19683030193a38cc7b2a57300000193c2b2a57301007473027303830108cdeeac93b1a5730405000500058092f4010100d802d6017300d602b2a4730100eb027201d195ed93b1a4730293b1db630872027303d806d603db63087202d604b2a5730400d605b2db63087204730500d606b27203730600d6077e8cb2db6308a77307000206d6087e9973088cb272037309000206ededededed938cb27203730a0001730b93c27204d07201938c7205018c720601927e9a99c17204c1a7730c069d9c72077ec17202067208927e8c720502069d9c72077e8c72060206720890b0ada5d90109639593c27209730dc17209730e730fd90109599a8c7209018c720902731073110e2030974274078845f263b4f21787e33cc99e9ec19a17ad85a5bc6da2cca91c5a2e050605ca0105d201040404c80f06010104d00f052404c80f0e691005040004000e36100204a00b08cd0279be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798ea02d192a39a8cc7a701730073011001020402d19683030193a38cc7b2a57300000193c2b2a57301007473027303830108cdeeac93b1a57304050005000580dac4090100d802d601b2a4730000d6027301d1ec730295ed93b1a4730393b1db630872017304d804d603db63087201d604b2a5730500d605b2db63087204730600d6067e8c72050206edededededed938cb2720373070001730893c272047309938c720501730a9272067e730b06927ec172040699997ec1a7069d9c72067e730c067e730d067202909c9c7e8cb27203730e00020672027e730f069c9a720673109a9c7ec17201067e7311067e9c73127e7313050690b0ada5d90107639593c272077314c1720773157316d90107599a8c7207018c72070273177318",
           |    "address": "D8FGQMLcKkMJqSoggnx5AgTPHDG2xvaeQVM5SukFeieEodT5ZbrENPhA4G3xDJtHt5rhYT4D1xrvnV6XSUVeVARiUfaKFLNXV5BPXuS2EEQVnkDedCiA7HbWLJbjSbSmk4DqcsAGdqUp8T7je3F2762iEbgSZnUGvZYhA1dTJKL3y3A9tJmTXTFFh8ofcbA2KA1f43Uu6zdW3iTENpMN7pM5E5s8Qgoa4RA3aGnoSReTBVPQVBQLN9ahKcGHVszCTXfBkKkzZtZS4ZL1KmQdUyPjmCAw8Frt2vgmEQDGrTuGxERsq5WhpG8dAh7vYJQB8o6q8Pr48GmbZb1NGwJKfzbHmV4XPFmmsFAsDwUDvBcTCF2pnX1iWY4Dj99WFWJrmmTvXDWsh7GncVEcwD3UshNYp3LpKEMQvZe5y9d73JNobuL9HErLHw2jADPDypmCayFZNcffEsNHwD2xUUAE7NixzQPPgc5XWX5TKjrSd2VZGgL9KehrqQ2v3QQmXAjFvz5BkyauJ9VP1VfxnRyrjTpdUybvzHfB2R3poqaYXh13iJLKoKmN73R4kMujwuj4KbLV9yTi6DRWrojAkAdBBf9k4MQ6giKzr447LvdoCoa2TKs7MV7xGswapG7XgbeD6zQdzRUeH8viaj6fx739Fud944NDyBuTFaVDLytWFJokyjEwmVdUHYtnD3pFY6KtSdReDrUihMXHJEAuJL9pSk4nF69Fpv9LyYSFSdoaZcKAHqsSNcfy1PKdBYRMKccS8DqYFNEnWwogdhHyEww24SgzXK83AHnHoMP7yz3mm77Xa2sqEEvJFWCeMDVzMqWezAQRBpYe4wQtwbHmXfazSpP1CZ9zxJ2p347XgWdrJK1magLKzdDb6a7mEEffGAYiqP3ZYxAdWMnDHYT1uak3NeBEUneGgrEqU2r45i7sAtmWmvhcyaMDP3JDWAwHVJgXeakVRu6BR7obnReVG8bcPSNwZW7b1dqykxFZ3mj8c3ArX1oD8ZgFKUf8HA9piGS3YpgkjdWkUMULUCSggF6mdgWKdLdSuua1YLPfsStmUFkbAJdKC5CzcFuZQZwW91hUFK6rEtgBy5FL1jUfT16w4Jgjm2cFdpWV4PUYsaEU1aT48cw6a2omjZVuTHa3D83rYo5G1hZNMDyWrYMjid3prukvCcpCEJXWb7PfHZ3Ry5FmEkYNcPgGG5fxFbVo",
           |    "assets": [],
           |    "additionalRegisters": {},
           |    "spentTransactionId": "a38afe8788f1e40cc6c91b3a2d4800818e7802678916abb75e8bd88dfa4269a9",
           |    "mainChain": true
           |}
           |""".stripMargin
      )
      .toOption
      .get
}
